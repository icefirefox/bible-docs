name: Build and Deploy Frontend (Dev)

on:
  push:
    branches:
      - master   # æ¨é€åˆ° main åˆ†æ”¯è§¦å‘éƒ¨ç½²

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout å‰ç«¯ä»£ç 
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2ï¸âƒ£ å®‰è£… Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'  # ä½ å¯ä»¥æ”¹æˆé¡¹ç›®ä½¿ç”¨çš„ç‰ˆæœ¬
          cache: 'npm'

      # 3ï¸âƒ£ å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm install
        working-directory: ./  # å¦‚æœå‰ç«¯åœ¨å­ç›®å½•ï¼Œæ¯”å¦‚ src/frontend å¯ä»¥æ”¹è·¯å¾„

      # 4ï¸âƒ£ è®¾ç½® dev ç¯å¢ƒå˜é‡
      - name: Copy dev env
        run: cp .env.development .env

      # 5ï¸âƒ£ æ„å»ºé¡¹ç›®
      - name: Build React project
        run: CI=false npm run build

      # 6ï¸âƒ£ ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° EC2
      - name: Upload build artifacts to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build/**"        # React build é»˜è®¤è¾“å‡ºåˆ° build/ ç›®å½•
          target: "/opt/bible-docs/"
          strip_components: 1       # å»æ‰ build ç›®å½•ï¼Œåªä¸Šä¼ é‡Œé¢çš„å†…å®¹

      - name: Add /bible location block
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ”§ Adding /bible location block to aibiblebook.com config..."

            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if ! grep -q "location /bible" /etc/nginx/sites-available/aibiblebook.com; then
              sudo sed -i '/location \//i \
                  \    # Bible å‰ç«¯\n\
                  \    location /bible {\n\
                  \        alias /opt/bible-docs;\n\
                  \        index index.html;\n\
                  \        try_files \$uri /index.html;\n\
                  \    }\n' /etc/nginx/sites-available/aibiblebook.com
              echo "âœ… /bible location added."
            else
              echo "â„¹ï¸ /bible location already exists, skipping."
            fi

            sudo nginx -t
            sudo systemctl reload nginx
